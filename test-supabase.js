const { createClient } = require('@supabase/supabase-js')

const supabaseUrl = 'https://kflrsxdvxfeadyjjeica.supabase.co'
const supabaseAnonKey = 'sb_publishable_IuDOljy0dzz9TLFOf72I3w_lzVCcwQB'

async function testSupabase() {
  console.log('üîß Testing Supabase connection...')
  
  const supabase = createClient(supabaseUrl, supabaseAnonKey)
  
  try {
    // –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è
    console.log('1. Testing authentication...')
    const { data: authData, error: authError } = await supabase.auth.getSession()
    if (authError) {
      console.log('‚ùå Auth error:', authError.message)
    } else {
      console.log('‚úÖ Auth check passed')
    }
    
    // –¢–µ—Å—Ç 2: –ß–∏—Ç–∞–Ω–Ω—è –∑ —Ç–∞–±–ª–∏—Ü—ñ —á–∞—Ç—É
    console.log('2. Testing chat messages table...')
    const { data: messages, error: messagesError } = await supabase
      .from('chat_messages')
      .select('*')
      .limit(5)
    
    if (messagesError) {
      console.log('‚ùå Chat messages error:', messagesError.message)
      
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —ñ—Å–Ω—É—î —Ç–∞–±–ª–∏—Ü—è
      console.log('Checking if table exists...')
      const { error: tableError } = await supabase
        .from('chat_messages')
        .select('id')
        .limit(1)
      
      if (tableError && tableError.code === '42P01') {
        console.log('‚ö†Ô∏è Table chat_messages does not exist!')
      }
    } else {
      console.log(`‚úÖ Found ${messages?.length || 0} messages`)
    }
    
    // –¢–µ—Å—Ç 3: Realtime –ø—ñ–¥–ø–∏—Å–∫–∞
    console.log('3. Testing Realtime subscription...')
    const channel = supabase.channel('test-channel')
    
    channel.subscribe((status) => {
      console.log(`‚úÖ Realtime status: ${status}`)
    })
    
    // –í—ñ–¥–ø–∏—Å–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏
    setTimeout(() => {
      supabase.removeChannel(channel)
      console.log('‚úÖ Realtime test completed')
    }, 2000)
    
    // –¢–µ—Å—Ç 4: –ó–∞–ø–∏—Å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    console.log('4. Testing message insertion...')
    const testMessage = {
      content: 'Test message from connection test',
      user_name: 'TestBot'
    }
    
    const { data: insertData, error: insertError } = await supabase
      .from('chat_messages')
      .insert([testMessage])
      .select()
    
    if (insertError) {
      console.log('‚ùå Insert error:', insertError.message)
      
      // –°–ø—Ä–æ–±—É—î–º–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é
      console.log('Trying to create table via SQL...')
      console.log('\nüìã Run this SQL in Supabase SQL Editor:')
      console.log(`
        CREATE TABLE IF NOT EXISTS chat_messages (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          content TEXT NOT NULL,
          user_name TEXT NOT NULL DEFAULT 'Anonymous',
          created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
        );
        
        ALTER TABLE chat_messages REPLICA IDENTITY FULL;
        
        INSERT INTO chat_messages (content, user_name) VALUES
          ('üëã Welcome to Global Chat!', 'System'),
          ('üåç Open in two browsers to test', 'System');
      `)
    } else {
      console.log('‚úÖ Message inserted:', insertData[0].id)
      
      // –í–∏–¥–∞–ª—è—î–º–æ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      const { error: deleteError } = await supabase
        .from('chat_messages')
        .delete()
        .eq('id', insertData[0].id)
      
      if (deleteError) {
        console.log('‚ö†Ô∏è Could not delete test message:', deleteError.message)
      } else {
        console.log('‚úÖ Test message cleaned up')
      }
    }
    
  } catch (error) {
    console.error('‚ùå Unexpected error:', error)
  }
}

testSupabase()
